# This is an example .goreleaser.yml file with some sensible defaults.
# Make sure to check the documentation at https://goreleaser.com

# The lines below are called `modelines`. See `:help modeline`
# Feel free to remove those if you don't want/need to use them.
# yaml-language-server: $schema=https://goreleaser.com/static/schema.json
# vim: set ts=2 sw=2 tw=0 fo=cnqoj

version: 2

before:
  hooks:
    # You may remove this if you don't use go modules.
    - go mod tidy
    # you may remove this if you don't need go generate
    - go generate ./...
    # pull samwaf web
    - curl -L https://github.com/samwafgo/SamWafWeb/releases/latest/download/dist.tar.gz -o dist.tar.gz
    - tar -zxvf dist.tar.gz
    - rm -rf public/dist
    - mv -f dist public
    - rm -rf dist.tar.gz
builds:
  # æ­£å¼å‘å¸ƒç‰ˆæœ¬ (Release builds)
  - id: "samwaf_linux"
    binary: "SamWafLinux64"
    env:
      - CGO_ENABLED=1
      - CC=x86_64-linux-gnu-gcc
      - CXX=x86_64-linux-gnu-g++
      - CGO_CFLAGS=-Wno-unused-variable
    goos:
      - linux
    goarch:
      - amd64
    ldflags:
      - -X SamWaf/global.GWAF_RELEASE=true
      - -X SamWaf/global.GWAF_RUNTIME_WIN7_VERSION=false
      - -X SamWaf/global.GWAF_RELEASE_VERSION_NAME={{ time "20060102" }}
      - -X SamWaf/global.GWAF_RELEASE_VERSION={{.Tag}}
      - -s -w
      - -extldflags "-static"
  - id: "samwaf_win"
    binary: "SamWaf64"
    env:
      - CGO_ENABLED=1
      - CC=x86_64-w64-mingw32-gcc
      - CXX=x86_64-w64-mingw32-g++
      - CGO_CFLAGS=-Wno-unused-variable
    goos:
      - windows
    goarch:
      - amd64
    ldflags:
      - -X SamWaf/global.GWAF_RELEASE=true
      - -X SamWaf/global.GWAF_RUNTIME_WIN7_VERSION=false
      - -X SamWaf/global.GWAF_RELEASE_VERSION_NAME={{ time "20060102" }}
      - -X SamWaf/global.GWAF_RELEASE_VERSION={{.Tag}}
      - -s -w
      - -extldflags "-static"
  - id: "samwaf_linux_arm64"
    binary: "SamWafLinuxArm64"
    env:
      - CGO_ENABLED=1
      - CC=aarch64-linux-gnu-gcc
      - CXX=aarch64-linux-gnu-g++
      - CGO_CFLAGS=-Wno-unused-variable
    goos:
      - linux
    goarch:
      - arm64
    ldflags:
      - -X SamWaf/global.GWAF_RELEASE=true
      - -X SamWaf/global.GWAF_RUNTIME_WIN7_VERSION=false
      - -X SamWaf/global.GWAF_RELEASE_VERSION_NAME={{ time "20060102" }}
      - -X SamWaf/global.GWAF_RELEASE_VERSION={{.Tag}}
      - -s -w
      - -extldflags "-static"
  
  # Debugç‰ˆæœ¬ (Debug builds for troubleshooting only)
  - id: "samwaf_linux_debug"
    binary: "SamWafLinux64-DEBUG-SYMBOLS"
    env:
      - CGO_ENABLED=1
      - CC=x86_64-linux-gnu-gcc
      - CXX=x86_64-linux-gnu-g++
      - CGO_CFLAGS=-Wno-unused-variable
    goos:
      - linux
    goarch:
      - amd64
    ldflags:
      - -X SamWaf/global.GWAF_RELEASE=true
      - -X SamWaf/global.GWAF_RUNTIME_WIN7_VERSION=false
      - -X SamWaf/global.GWAF_RELEASE_VERSION_NAME={{ time "20060102" }}
      - -X SamWaf/global.GWAF_RELEASE_VERSION={{.Tag}}-debug
      - -extldflags "-static"
  - id: "samwaf_win_debug"
    binary: "SamWaf64-DEBUG-SYMBOLS"
    env:
      - CGO_ENABLED=1
      - CC=x86_64-w64-mingw32-gcc
      - CXX=x86_64-w64-mingw32-g++
      - CGO_CFLAGS=-Wno-unused-variable
    goos:
      - windows
    goarch:
      - amd64
    ldflags:
      - -X SamWaf/global.GWAF_RELEASE=true
      - -X SamWaf/global.GWAF_RUNTIME_WIN7_VERSION=false
      - -X SamWaf/global.GWAF_RELEASE_VERSION_NAME={{ time "20060102" }}
      - -X SamWaf/global.GWAF_RELEASE_VERSION={{.Tag}}-debug
      - -extldflags "-static"
  - id: "samwaf_linux_arm64_debug"
    binary: "SamWafLinuxArm64-DEBUG-SYMBOLS"
    env:
      - CGO_ENABLED=1
      - CC=aarch64-linux-gnu-gcc
      - CXX=aarch64-linux-gnu-g++
      - CGO_CFLAGS=-Wno-unused-variable
    goos:
      - linux
    goarch:
      - arm64
    ldflags:
      - -X SamWaf/global.GWAF_RELEASE=true
      - -X SamWaf/global.GWAF_RUNTIME_WIN7_VERSION=false
      - -X SamWaf/global.GWAF_RELEASE_VERSION_NAME={{ time "20060102" }}
      - -X SamWaf/global.GWAF_RELEASE_VERSION={{.Tag}}-debug
      - -extldflags "-static"
upx:
  - # Whether to enable it or not.
    #
    # Templates: allowed.
    enabled: false

    # Filter by build ID.
    ids: [samwaf_linux,samwaf_win]

    # Compress argument.
    # Valid options are from '1' (faster) to '9' (better), and 'best'.
    compress: best

archives:
  - id: "release_archives"
    builds: ["samwaf_linux", "samwaf_win", "samwaf_linux_arm64"]
    format: tar.gz
    # this name template makes the OS and Arch compatible with the results of `uname`.
    name_template: >-
      {{ .ProjectName }}_
      {{- title .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}
      {{.Tag}}
    # use zip for windows archives
    format_overrides:
      - goos: windows
        format: zip
  - id: "debug_archives"
    builds: ["samwaf_linux_debug", "samwaf_win_debug", "samwaf_linux_arm64_debug"]
    format: tar.gz
    # Debugç‰ˆæœ¬ä½¿ç”¨ç‰¹æ®Šå‘½åï¼Œä»¥DEBUGå¼€å¤´ä¾¿äºç”¨æˆ·è¯†åˆ«å’Œåˆ†ç»„
    name_template: >-
      DEBUG_{{ .ProjectName }}_
      {{- title .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}
      {{.Tag}}_SYMBOLS
    # use zip for windows archives
    format_overrides:
      - goos: windows
        format: zip
changelog:
  sort: asc
  groups:
    - title: Features
      regexp: '^.*?feat(\([[:word:]]+\))??!?:.+$'
      order: 0
    - title: "Bug fixes"
      regexp: '^.*?fix(\([[:word:]]+\))??!?:.+$'
      order: 1
    - title: Others
      order: 999
  filters:
    exclude:
      - "^docs:"
      - "^test:"

release:
  # If you want to manually examine the release before its live, uncomment this line:
  # draft: true
  # Whether to remove existing draft releases with the same name before creating a new one.
  # Only effective if `draft` is set to true.
  # Default: false.
  replace_existing_draft: true
  # Useful if you want to delay the creation of the tag in the remote.
  # You can create the tag locally, but not push it, and run GoReleaser.
  # It'll then set the `target_commitish` portion of the GitHub release to the value of this field.
  # Only works on GitHub.
  #
  # Default: ''
  target_commitish: "{{ .Commit }}"
  # If set to auto, will mark the release as not ready for production in case there is an indicator for this in the tag e.g. v1.0.0-rc1 .
  # If set to true, will mark the release as not ready for production.
  # Default is false.
  prerelease: auto
  # What to do with the release notes in case there the release already exists.
  #
  # Valid options are:
  # - `keep-existing`: keep the existing notes
  # - `append`: append the current release notes to the existing notes
  # - `prepend`: prepend the current release notes to the existing notes
  # - `replace`: replace existing notes
  #
  # Default is `keep-existing`.
  mode: append
  # Header for the release body.
  #
  # Templates: allowed
  header: |
    ## SamWaf Release {{.Tag}} ({{ .Date }})
    
    ### ğŸ“¦ æ­£å¼å‘å¸ƒç‰ˆæœ¬ (Release Builds)
    æ¨èç”¨æˆ·ä¸‹è½½ä½¿ç”¨çš„æ­£å¼ç‰ˆæœ¬ï¼Œç»è¿‡ä¼˜åŒ–å’Œæµ‹è¯•ï¼š
    
    ### ğŸ”§ è°ƒè¯•ç‰ˆæœ¬ (Debug Builds - For Troubleshooting Only)
    **âš ï¸ æ³¨æ„ï¼šè°ƒè¯•ç‰ˆæœ¬ä»…ä¾›é—®é¢˜æ’æŸ¥ä½¿ç”¨ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨**
    
    è°ƒè¯•ç‰ˆæœ¬åŒ…å«å®Œæ•´çš„è°ƒè¯•ç¬¦å·ï¼Œæ–‡ä»¶è¾ƒå¤§ï¼Œä»…åœ¨éœ€è¦è¿›è¡Œé—®é¢˜è¯Šæ–­æ—¶ä¸‹è½½ï¼š
    - æ–‡ä»¶ååŒ…å« `DEBUG_SYMBOLS` æ ‡è¯†
    - ç‰ˆæœ¬å·åŒ…å« `-debug` åç¼€
    - ä¿ç•™äº†å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜å®šä½
    
  # Footer for the release body.
  #
  # Templates: allowed
  footer: |
    ---
    
    ### ğŸ“‹ ç‰ˆæœ¬è¯´æ˜
    - **æ­£å¼ç‰ˆæœ¬**ï¼šæ¨èç”¨æˆ·ä½¿ç”¨ï¼Œç»è¿‡ä¼˜åŒ–ï¼Œæ–‡ä»¶è¾ƒå°
    - **è°ƒè¯•ç‰ˆæœ¬**ï¼šä»…ä¾›æŠ€æœ¯æ”¯æŒå’Œé—®é¢˜æ’æŸ¥ä½¿ç”¨ï¼ŒåŒ…å«è°ƒè¯•ç¬¦å·ï¼Œæ–‡ä»¶è¾ƒå¤§
    
    ### ğŸ†˜ æŠ€æœ¯æ”¯æŒ
    å¦‚é‡åˆ°é—®é¢˜éœ€è¦æŠ€æœ¯æ”¯æŒï¼Œè¯·ï¼š
    1. ä¼˜å…ˆä½¿ç”¨æ­£å¼ç‰ˆæœ¬
    2. å¦‚éœ€é—®é¢˜æ’æŸ¥ï¼Œå¯ä¸‹è½½å¯¹åº”çš„è°ƒè¯•ç‰ˆæœ¬
    3. æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—
    
    **Full Changelog**: https://github.com/samwafgo/SamWaf/compare/{{.PreviousTag}}...{{.Tag}}
